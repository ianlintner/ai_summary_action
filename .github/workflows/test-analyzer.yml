name: Test Error Analyzer

on:
  workflow_dispatch:

jobs:
  # Job that intentionally fails with a stack trace
  create-error:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Trigger Error with Stack Trace
        run: |
          node -e "
          function deepFunction() {
            throw new Error('Intentional test error: Database connection failed at line 42');
          }
          
          function middleFunction() {
            deepFunction();
          }
          
          function topFunction() {
            middleFunction();
          }
          
          topFunction();
          "
  
  # Analyze the failure using the AI action
  analyze-failure:
    runs-on: ubuntu-latest
    if: failure()
    needs: [create-error]
    permissions:
      actions: read
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Analyze Workflow Failure with OpenAI
        uses: ./
        continue-on-error: true
        with:
          github-token: ${{ github.token }}
          llm-provider: 'openai'
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          openai-model: 'gpt-4o-mini'
          max-log-lines: '500'
      
      - name: Analyze Workflow Failure with GitHub Models
        uses: ./
        continue-on-error: true
        with:
          github-token: ${{ github.token }}
          llm-provider: 'github-models'
          github-models-token: ${{ secrets.GITHUB_MODELS_TOKEN }}
          github-models-model: 'gpt-4o'
      
      - name: Analyze Workflow Failure with Anthropic
        uses: ./
        continue-on-error: true
        with:
          github-token: ${{ github.token }}
          llm-provider: 'anthropic'
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          anthropic-model: 'claude-3-5-sonnet-20241022'
